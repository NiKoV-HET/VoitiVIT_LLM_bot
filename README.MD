# Войти в IT Bot

Этот проект – Telegram-бот, созданный для конференции **Войти в IT**. Бот помогает участникам конференции изучать применение больших языковых моделей (LLM) в учебе, работе и повседневной жизни, предоставляя интерактивное меню, динамический контент, мультимедийные материалы и возможность оставить отзыв.

## Функционал

- **Интерактивное меню:**
  - При команде `/start` пользователю показывается постоянная клавиатура с тремя кнопками: **Основное меню**, **О боте**, **Оставить обратную связь**.
  - Нажатие на кнопку **Основное меню** выводит inline‑клавиатуру с категориями, заданными в базе данных.
  - При выборе категории меню обновляется: показываются подкатегории с кнопкой **Назад** для возврата к списку категорий.
- **Динамическое наполнение контента:**
  - Категории и подтемы загружаются из базы данных (PostgreSQL), что позволяет изменять их без обновления кода бота.
  - При выборе подтемы бот отправляет подробное текстовое описание с мультимедийным контентом (GIF или видео), а также форматирует сообщение с использованием HTML‑тегов (например, для выделения текста жирным).
- **Обратная связь:**
  - Пользователь может оставить отзыв через команду `/feedback` или нажав соответствующую кнопку. Отзывы сохраняются в базе данных.
- **Автоматическая регистрация пользователей:**
  - При первом обращении к боту пользователь автоматически регистрируется в таблице `users`. Для регистрации используются данные из объекта `update.effective_user`.
- **Логирование и защита:**
  - Все действия пользователя (выбор категорий, подкатегорий, отправка отзывов) логируются.
  - Реализовано ограничение частоты запросов для защиты от перегрузок.
- **Обращения к LLM:**
  - У пользователей есть несколько обращений к LLM, версию LLM можно узнать в `/about`.
  - Поддержка отправки изображений в LLM - пользователь может отправить фотографию с подписью или без, и бот обработает её с помощью LLM.
  - Изображения сохраняются в хранилище Minio для дальнейшего использования.

## Стек технологий

- **Python** с библиотекой [python-telegram-bot](https://github.com/python-telegram-bot/python-telegram-bot)
- **SQLAlchemy** (асинхронный режим)
- **PostgreSQL** – база данных
- **Alembic** – для миграций базы данных
- **Docker** и **Docker Compose** – для контейнеризации и удобного развертывания
- **Minio** – объектное хранилище для изображений
- **OpenAI API** – для обработки запросов к LLM

## Структура проекта

```c#
project/ 
├── alembic/ # Миграции Alembic 
├── bot/ # Исходный код бота 
│ ├── config.py # Конфигурация (переменные окружения) 
│ ├── database.py # Настройка подключения к базе данных 
│ ├── models.py # Модели SQLAlchemy (пользователи, категории, подтемы, отзывы, логи) 
│ ├── keyboards.py # Функции для формирования клавиатур Telegram 
│ ├── handlers.py # Обработчики команд и сообщений 
│ ├── llm.py # Функции для работы с LLM API
│ ├── storage.py # Функции для работы с Minio
│ └── __init__.py # Инициализация пакета
├── main.py # Точка входа в приложение
├── docker-compose.yaml # Конфигурация Docker Compose 
├── Dockerfile # Конфигурация Docker основного приложения
├── .env # Файл переменных окружения 
├── .env_example # Пример файла переменных окружения 
├── requirements.txt # Зависимости Python 
└── README.md # Этот файл
```

## Переменные окружения

Создайте файл `.env` подобный `.env_example` в корне проекта и заполните переменные:

```
BOT_TOKEN=ваш_токен_бота
POSTGRES_USER=postgres_user
POSTGRES_PASSWORD=postgres_password
POSTGRES_DB=postgres_db
POSTGRES_HOST=postgres
POSTGRES_PORT=5432
SUPERUSER_TG_ID=ваш_telegram_id
SUPERUSER_TG_NICK=ваш_telegram_ник
SUPERUSER_TG_NAME=ваше_имя
LLM_API_KEY=ваш_ключ_api
LLM_API_BASE_URL=https://openrouter.ai/api/v1
LLM_API_MODEL=openai/gpt-4o
PROXY_URL=ваш_прокси_url
DEFAULT_LIMIT_LLM=20

# Настройки Minio
MINIO_ROOT_USER=minio_user
MINIO_ROOT_PASSWORD=minio_password
MINIO_HOST=minio
MINIO_PORT=9000
MINIO_BUCKET_NAME=user-images
```

## Запуск проекта с Docker Compose

1) Сборка и запуск контейнеров:

Выполните в корне проекта:

```bash
docker-compose up -d --build
```

Это запустит:

- Контейнер для бота.
- Контейнер с PostgreSQL.
- Контейнер с Minio для хранения изображений.

2) Применение миграций:

При первом старте бота необходимо запустить миграции вручную:

```bash
docker-compose exec app bash
alembic upgrade head
```

## Использование

Запустите бота.  
Найдите вашего бота в Telegram и нажмите `/start`.

### Навигация по меню

После команды `/start` вы получите постоянную клавиатуру с кнопками Основное меню, О боте, Оставить обратную связь.
Нажмите Основное меню, чтобы увидеть список категорий.
Выберите нужную категорию, чтобы перейти к подкатегориям. Для возврата используйте кнопку Назад.

### Команды

`/start` – запуск бота и вывод меню.  
`/about` – информация о боте.  
`/feedback` – оставить отзыв.  
`/llm_enable` – включить LLM (только для суперпользователя).
`/llm_disable` – выключить LLM (только для суперпользователя).
`/llm_set_limit` – установить лимит запросов для пользователя (только для суперпользователя).
`/llm_set_model` – установить модель LLM для пользователя (только для суперпользователя).
`/llm_user_enable` – включить LLM для пользователя (только для суперпользователя).
`/llm_user_disable` – выключить LLM для пользователя (только для суперпользователя).

### Работа с изображениями

Бот поддерживает отправку изображений для обработки с помощью LLM:

1. **Отправка изображения с подписью**: Отправьте фотографию с подписью, и бот сразу отправит её вместе с текстом в LLM и вернёт ответ.
2. **Отправка изображения без подписи**: Отправьте фотографию без подписи, и бот сохранит её. Следующее текстовое сообщение будет отправлено вместе с этим изображением в LLM.

Все изображения сохраняются в Minio и информация о них записывается в базу данных для дальнейшего использования.

## Доступ к Minio

Веб-интерфейс Minio доступен по адресу: http://localhost:9001
- Логин: minio_user (или значение из MINIO_ROOT_USER)
- Пароль: minio_password (или значение из MINIO_ROOT_PASSWORD)

